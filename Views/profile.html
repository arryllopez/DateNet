<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Page</title>
    <!-- <link rel="stylesheet" href="profile.css"> -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
    <style>
        /* General Styling */
body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background-color: #f9f9f9;
}

/* Profile Container */
.profile-container {
    max-width: 800px;
    margin: 40px auto;
    padding: 30px;
    background-color: #fff;
    border-radius: 10px;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
}

/* Profile Heading */
.profile-container h1 {
    font-size: 24px;
    font-weight: bold;
    text-align: center;
    margin-bottom: 20px;
    color: #333;
}

/* Profile Picture Section */
.profile-picture-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 20px;
}

.profile-picture-section label {
    font-weight: bold;
    margin-bottom: 10px;
    color: #555;
    font-size: 14px;
}

.profile-picture-section input[type="file"] {
    margin-bottom: 10px;
    padding: 8px;
    font-size: 14px;
    cursor: pointer;
    border-radius: 4px;
    border: 1px solid #ddd;
}

.profile-picture-section img {
    width: 120px;
    height: 120px;
    margin-left: 60px;;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #007BFF;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    display: none; /* Hidden until an image is loaded */
}

/* Form Styling */
form {
    display: flex;
    flex-direction: column;
}

form label {
    font-weight: bold;
    margin-top: 15px;
    color: #555;
    font-size: 14px;
}

form input,
form select,
form textarea {
    margin-top: 5px;
    padding: 12px;
    font-size: 14px;
    border: 1px solid #ddd;
    border-radius: 6px;
    background-color: #f9f9f9;
    transition: border-color 0.3s ease;
}

form input:focus,
form select:focus,
form textarea:focus {
    border-color: #007BFF;
    outline: none;
    background-color: #fff;
}

form textarea {
    resize: vertical;
    min-height: 80px;
}

form button {
    margin-top: 20px;
    padding: 12px 20px;
    background-color: #007BFF;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

form button:hover {
    background-color: #0056b3;
}

/* Checkbox Group */
.checkbox-group {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-top: 5px;
}

.checkbox-group label {
    font-size: 14px;
    color: #555;
    display: flex;
    align-items: center;
    gap: 5px;
}

/* Responsive Design */
@media (max-width: 768px) {
    .profile-container {
        padding: 20px;
    }

    form input,
    form select,
    form textarea {
        font-size: 12px;
    }

    form button {
        font-size: 14px;
        padding: 10px;
    }
}

/* Navigation Bar (Unchanged) */
nav {
    position: absolute;
    font-weight: bold;
    top: 0;
    right: 0;
    left: 0; /* Make the navbar span the full width */
    background-color: white; /* Red background color */
    padding: 1rem;
    color: white; /* White text for better contrast */
}

nav ul {
    display: flex;
    list-style-type: none;
    gap: 1.5rem;
    margin: 0;
    padding: 0;
    justify-content: flex-end; /* Align navigation items to the right */
}

nav ul li a {
    color: black; /* Ensure text is white */
    text-decoration: none;
    transition: color 0.3s ease;
}

nav ul li a:hover {
    color: red; /* Change color on hover for better visibility */
}

header {
    background-color: #ffffff;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

nav ul li a svg {
    vertical-align: middle;
    margin-right: 0.5rem;
}

.header-content {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    padding: 1rem 0;
}

    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <nav>
                    <ul>
                        <li><span id="greeting" style="color: black; font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;"></span></li>
                        <li><a href="messagesAndChat.html"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg> Messages</a></li>
                        <li><a href="match.html"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg> Matches</a></li>
                        <li><a href="generalChat.html"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg> Global Chat</a></li>
                        <li><a href="profile.html"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg> Profile</a></li>
                        <li><a href="#" onclick="logout();"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg> Logout</a>
                        </li>
                        <li><a href="CRUD.html" id="managetab" style="display: none;"><img src="Images/manager.png" alt="manage" width="30px" height="30px"></a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <main>
        <div class="profile-container">
            <h1>Your Profile</h1>
            <form id="profileForm">
                <!-- Profile Picture Section -->
                <div class="profile-picture-section">
                   
                        <label for="profilePic">Main Profile Picture</label>
                        <section id="profilePicSection">
                            <!-- <input type="file" id="profilePic" name="profilePic">
                            <img id="profilePicImage" style="display: none; max-width: 100px;" alt="Profile Photo"> -->
                            <input type="file" id="profilePic" onchange="previewImage()">
                             <img id="profilePicPreview" style="max-width: 200px; display: none;">
                        </section>
                </div>
        
                <!-- Basic Information -->
                <label for="name">Name</label>
                <input type="text" id="name" name="name" disabled>
        
                <label for="age">Age</label>
                <input type="number" id="age" name="age" disabled>
        
                <label for="gender">Gender</label>
                <input type="text" id="gender" name="gender" disabled>
        
                <!-- Preferred Age Range -->
                <label for="prefage">Preferred Age Range</label>
                <select id="prefage" name="prefage">
                    <option value="18-25">18-25</option>
                    <option value="25-32">25-32</option>
                </select>
        
                <!-- Preferred Gender -->
                <label for="prefgender">Preferred Gender</label>
                <select id="prefgender" name="prefgender">
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Other">Other</option>
                </select>
        
                <!-- Preferred Interests -->
                <label for="selfinterests">Your Interests</label>
                <br>
                <fieldset>
                <table>        
                <th style="font-family:'Times New Roman', Times, serif;">General</th>
                <tr>
                <td><input type="checkbox" id="selfinterests" name="selfinterests" value="Reading"> Reading</td>
                <td><input type="checkbox" id="selfinterests" name="selfinterests" value="Traveling"> Traveling</td>
                <td><input type="checkbox" id="selfinterests" name="selfinterests" value="Sports"> Sports</td>
                <td><input type="checkbox" id="selfinterests" name="selfinterests" value="Cooking"> Cooking</td>
            </tr>
        
           <th style="font-family:'Times New Roman', Times, serif;">Knowledge-Wise</th>
                <tr> 
                <td><input type="checkbox" id="selfinterests" name="selfinterests" value="Coding"> Coding</td>
                <td><input type="checkbox" id="selfinterests" name="selfinterests" value="Astronomy"> Astronomy</td>
                <td><input type="checkbox" id="selfinterests" name="selfinterests" value="Robotics"> Robotics</td>
                <td><input type="checkbox" id="selfinterests" name="selfinterests" value="Robotics"> Automobiles</td>
            
            </tr>
                </table>
            </fieldset>
        
                <!-- Relation Looking For -->
                <label for="lookingFor">What Kind of Relation are you looking for?</label>
                <select id="lookingFor" name="lookingFor">
                    <option value="LongTerm">Long Term Relationship</option>
                    <option value="ShortTerm">Short Term Relationship</option>
                    <option value="AFriend">A Friend</option>
                    <option value="BusinessNetwork">Business Network</option>
                    <option value="Coworker">Co-Worker for a project</option>
                </select>
        
                <!-- Additional User Information -->
                <!-- <label for="selfinterests">Your Interests</label>
                <input type="text" id="selfinterests" name="selfinterests"> -->
        
                <label for="hobbies">Hobbies</label>
                <textarea id="hobbies" name="hobbies"></textarea>
        
                <label for="location">Location</label>
                <input type="checkbox" id="location" name="location" value="Oshawa"> Oshawa
                <input type="checkbox" id="location" name="location" value="Courtice"> Courtice
                <input type="checkbox" id="location" name="location" value="Oshawa"> Ajax
                <input type="checkbox" id="location" name="location" value="Courtice"> Toronto
        
                <label for="program">Program</label>
                <input type="text" id="program" name="program">
        
                <label for="faculty">Faculty</label>
                <input type="text" id="faculty" name="faculty">
        
                <label for="year">Year</label>
                <input type="number" id="year" name="year" min="1" max="5">
        
                <label for="business">If you were to start a business, what would it be?</label>
                <textarea id="business" name="business"></textarea>
        
                <label for="futureGoals">What are your goals for the future?</label>
                <textarea id="futureGoals" name="futureGoals"></textarea>
        
                <label for="importantThing">What is the most important thing in your life?</label>
                <textarea id="importantThing" name="importantThing"></textarea>
        
                <label for="bio">Bio</label>
                <textarea id="bio" name="bio"></textarea>
        
                <label for="achievements">Achievements</label>
                <textarea id="achievements" name="achievements"></textarea>

                <div id="roleContainer" style="display: none;">
                <label for="role">Role</label>
                <select id="role" name="role">
                    <option value="user">User</option>
                    <option value="admin">Admin</option>
                </select>
                </div>

                <label for="profileStatus" >Profile Status</label>
                <select id="profileStatus" name="profileStatus">
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                </select>
                
        
                <!-- Submit Button -->
                <button type="submit">Save Changes</button>
            </form>
        </div>
        
    </main>
    <!-- <script src="profile.js"></script> -->
    <script>
        function logout() {
        
        localStorage.removeItem('token'); 
        
        window.location.href = 'login.html';
    }
        function previewImage() {
            const file = document.getElementById('profilePic').files[0];
            const reader = new FileReader();

            reader.onloadend = function() {
                document.getElementById('profilePicPreview').src = reader.result;
                document.getElementById('profilePicPreview').style.display = 'block';
            }

            if (file) {
                reader.readAsDataURL(file);
            } else {
                document.getElementById('profilePicPreview').src = "";
                document.getElementById('profilePicPreview').style.display = 'none';
            }
        }
        function displayImageFromDatabase(base64Data) {
            const imgElement = document.getElementById('profilePicPreview');
            // imgElement.src = base64Data;
            // imgElement.src = `data:image/jpeg;base64,${base64Data}`;
            if (base64Data.startsWith('data:image')) {
            imgElement.src = base64Data;
        } else {
            // Add the prefix if it's not already included
            imgElement.src = `data:image/jpeg;base64,${base64Data}`;
        }
            imgElement.style.display = 'block';
            // imgElement.style.border = '2px solid blue';
        }

        document.addEventListener('DOMContentLoaded', async () => {
    try {
        const response = await fetch('http://localhost:3000/api/auth/profile', {
            headers: {
                Authorization: `Bearer ${localStorage.getItem('token')}`,
            },
          });

        const data = await response.json();

        if (response.ok) {
            
            console.log("Fetched Profile Data:", data);
            

                const calculateAge = (dob) => {
                    const birthDate = new Date(dob);
                    const diff = Date.now() - birthDate.getTime();
                    return new Date(diff).getUTCFullYear() - 1970;
                };

                document.getElementById('greeting').innerHTML =" Welcome " +`${data.firstName}`;
                document.getElementById('name').value = `${data.firstName} ${data.lastName}`;
                document.getElementById('gender').value = `${data.gender}`;
                document.getElementById('age').value = calculateAge(data.dateOfBirth);
                if (data.preferredAge) {
                    document.getElementById('prefage').value = data.preferredAge;
                }
                if (data.preferredgender) {
                    document.getElementById('prefgender').value = data.preferredgender;
                }
                if (data.interests) {
                    document.querySelectorAll('input[name="selfinterests"]').forEach(checkbox => {
                        if (data.interests.includes(checkbox.value)) {
                            checkbox.checked = true;
                        }
                    });
                }
                if (data.lookingFor) {
                    document.getElementById('lookingFor').value = data.lookingFor;
                }
                if (data.location) {
                    document.querySelectorAll('input[name="location"]').forEach(checkbox => {
                        if (data.location.includes(checkbox.value)) {
                            checkbox.checked = true;
                        }
                    });
                }
                //document.getElementById('selfinterests').value = data.interests || '';
                document.getElementById('hobbies').value = data.hobbies || '';
                document.getElementById('location').value = data.location || '';
                document.getElementById('program').value = data.program || '';
                document.getElementById('faculty').value = data.faculty || '';
                document.getElementById('year').value = data.year || '';
                document.getElementById('business').value = data.businessToStart || '';
                document.getElementById('futureGoals').value = data.futureGoals || '';
                document.getElementById('importantThing').value = data.mostImportantThing || '';
                document.getElementById('bio').value = data.bio || '';
                document.getElementById('achievements').value = data.achievements || '';
                if (data.role === 'admin') {
                    document.getElementById('roleContainer').style.display = 'block';
                    document.getElementById('role').value = data.role;
                    document.getElementById('managetab').style.display = 'block';
                    document.getElementById('managetab').style.fontSize = 'bold';
                }
                document.getElementById('profileStatus').value = data.profileStatus || 'active';
 
            //     if (data.profilePhoto) {
            //         // loadImage(data.profilePhoto, 'profilePicImage');
            //         console.log("Profile Photo Base64 Data:", data.profilePhoto);
            //         const profilePicImage = document.getElementById('profilePicImage');
            //     profilePicImage.src = data.profilePhoto;
            //     profilePicImage.style.display = 'block';
               
            //     }else {
            //     console.warn("No profile photo found.");
            // }
                
            //     if (data.displayPic1) {
            //         // loadImage(data.displayPic1, 'displayPic1Image');
            //         console.log("Display Picture 1 Base64 Data:", data.displayPic1);
            //         const displayPic1Image = document.getElementById('displayPic1Image');
            //         displayPic1Image.src = data.displayPic1;
            //         displayPic1Image.style.display = 'block';
                    
            //     } else {
            //         console.warn("No additional display picture found.");
            // }

            // loadImage(data.profilePhoto, 'profilePicImage'); 
            // loadImage(data.displayPic1, 'displayPic1Image');
            
            if (data.profilePhoto) {
                displayImageFromDatabase(data.profilePhoto);
            }
            // if (data.displayPic1) {
                
            // }
            
                
            } else {
                alert(data.message || 'Error fetching profile data.');
            }
        } catch (error) {
        console.error('Error fetching profile data:', error);
    }
    function convertToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = (error) => reject(error);
        });
    }
    function loadImage(data, imageId) {
    const imageElement = document.getElementById(imageId);
    if (data && imageElement) {
        imageElement.src = data;  // Assuming data is a URL or Base64 string
        imageElement.style.display = 'block';  // Make sure the element is visible
    }
}

    // document.getElementById('profilePic').addEventListener('change', async (event) => {
    //     const file = event.target.files[0];
    //         if (file) {
    //             const base64 = await convertToBase64(file);
    //             document.getElementById('profilePicImage').src = base64;
    //             document.getElementById('profilePicImage').style.display = 'block';
    //         }
    //     });

        // document.getElementById('displayPic1').addEventListener('change', async (event) => {
        //     const file = event.target.files[0];
        //     if (file) {
        //         const base64 = await convertToBase64(file);
        //         document.getElementById('displayPic1Image').src = base64;
        //         document.getElementById('displayPic1Image').style.display = 'block';
        //     }
        // });
    

    document.getElementById('profileForm').addEventListener('submit', async (e) => {
        e.preventDefault();
       
        const dpimageBase64 = document.getElementById('profilePicPreview').src;
        // const displayimageBase64 = document.getElementById('displayPicPreview').src;

        
        const bio = document.getElementById('bio').value;
        // const selfinterests = document.getElementById('selfinterests').value;
        const hobbies = document.getElementById('hobbies').value;
        //need to add html for the below
        
        const program = document.getElementById('program').value;
        const faculty = document.getElementById('faculty').value;
    const year = document.getElementById('year').value;// need to add the html for above
        const business = document.getElementById('business').value;
        const futureGoals = document.getElementById('futureGoals').value;
        const importantThing = document.getElementById('importantThing').value;

      
        const lastlogin = new Date().toISOString();
        const achievements = document.getElementById('achievements').value;
        const PreferredAge = document.getElementById('prefage').value;
        const PreferredGender = document.getElementById('prefgender').value;
        
        const lookingFor = document.getElementById('lookingFor').value;

        const getSelectedCheckboxValues = () => {
            const checkboxes = document.querySelectorAll('input[name="selfinterests"]:checked');
            // Map through NodeList and get the value of each checkbox, then join with a comma
            const values = Array.from(checkboxes).map(checkbox => checkbox.value).join(', ');
            return values;
        };

        const Interests = getSelectedCheckboxValues();
        const getLocationValues = () => {
            const checkboxes = document.querySelectorAll('input[name="location"]:checked');
            // Map through NodeList and get the value of each checkbox, then join with a comma
            const values = Array.from(checkboxes).map(checkbox => checkbox.value).join(', ');
            return values;
        };
        const location = getLocationValues();
        const ROLE = document.getElementById('role').value ;
        try {
            const response = await fetch('http://localhost:3000/api/auth/profile', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    Authorization: `Bearer ${localStorage.getItem('token')}`,
                },
                
                body: JSON.stringify({profilePhoto: dpimageBase64, bio: bio, interests: Interests, hobbies: hobbies, location : location , program :program ,faculty: faculty,  year: year, futureGoals: futureGoals, businessToStart: business, mostImportantThing: importantThing, lastlogin: lastlogin, achievements: achievements, preferredAge : PreferredAge, preferredgender : PreferredGender, lookingFor: lookingFor, role: ROLE}),
            });
            const data = await response.json();
            if (response.ok) {
                alert('Profile updated successfully!');
            } else {
                alert(data.message || 'Error updating profile.');
            }
        } catch (error) {
            console.error('Error updating profile:', error);
        }
    });
});
    </script>
</body>
</html>